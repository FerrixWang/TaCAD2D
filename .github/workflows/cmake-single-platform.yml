name: CMake on Windows

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

env:
  BUILD_TYPE: Release
  PYTHON_VERSION: '3.12'  # Use Python 3.12 for better compatibility with pyzstd

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Cache Qt
      id: cache-qt
      uses: actions/cache@v4
      with:
        path: ${{github.workspace}}/Qt
        key: ${{runner.os}}-qt-${{hashFiles('**/CMakeLists.txt')}}
        restore-keys: ${{runner.os}}-qt-

    - name: Install Qt
      uses: jurplel/install-qt-action@v4
      with:
        version: '6.7.2'  # Specify a specific Qt version for consistency
        arch: win64_msvc2022_64
        cached: ${{steps.cache-qt.outputs.cache-hit}}

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{env.PYTHON_VERSION}}
        cache: 'pip'  # Cache Python dependencies
        cache-dependency-path: '**/requirements.txt'  # Adjust if requirements file exists

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install pyzstd --only-binary :all: || pip install zstandard
      shell: cmd  # Ensure Windows-compatible shell

    - name: Verify Python libraries
      run: |
        dir "C:\hostedtoolcache\windows\Python\${{env.PYTHON_VERSION}}*\x64\libs"
        dir "C:\hostedtoolcache\windows\Python\${{env.PYTHON_VERSION}}*\x64\PCbuild\amd64"
      shell: cmd
      continue-on-error: true  # Continue even if directories are missing for debugging

    - name: Configure CMake
      run: |
        cmake -B ${{github.workspace}}/build -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} -A x64
      shell: cmd

    - name: Build
      run: |
        cmake --build ${{github.workspace}}/build --config ${{env.BUILD_TYPE}} --parallel
      shell: cmd

    - name: Test
      working-directory: ${{github.workspace}}/build
      run: |
        ctest -C ${{env.BUILD_TYPE}} --output-on-failure
      shell: cmd
